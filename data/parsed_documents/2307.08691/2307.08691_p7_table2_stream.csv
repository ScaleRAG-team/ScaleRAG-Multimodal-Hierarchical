"","exponentials in the softmax. We include the backward pass description in Algorithm 2 for completeness.","",""
"Algorithm 2 FlashAttention-2 Backward Pass","","",""
"","Require: Matrices Q, K, V, O, dO âˆˆ Rğ‘ Ã—ğ‘‘ in HBM, vector ğ¿ âˆˆ Rğ‘ in HBM, block sizes ğµğ‘, ğµğ‘Ÿ .","",""
"","","",""
"","","","(cid:109) blocks"
"1: Divide Q into ğ‘‡ğ‘Ÿ =
ğµğ‘Ÿ","(cid:109) blocks Q1, . . . , Qğ‘‡ğ‘Ÿ of size ğµğ‘Ÿ Ã— ğ‘‘ each, and divide K, V in to ğ‘‡ğ‘ =","ğµğ‘",""
"K1, . . . , Kğ‘‡ğ‘ and V1, . . . , Vğ‘‡ğ‘ , of size ğµğ‘ Ã— ğ‘‘ each.","","",""
"","2: Divide O into ğ‘‡ğ‘Ÿ blocks Oğ‘–, . . . , Oğ‘‡ğ‘Ÿ of size ğµğ‘Ÿ Ã— ğ‘‘ each, divide dO into ğ‘‡ğ‘Ÿ blocks dOğ‘–, . . . , dOğ‘‡ğ‘Ÿ of size","",""
"","","",""
"ğµğ‘Ÿ Ã— ğ‘‘ each, and divide ğ¿ into ğ‘‡ğ‘Ÿ blocks ğ¿ğ‘–, . . . , ğ¿ğ‘‡ğ‘Ÿ of size ğµğ‘Ÿ","","",""
"Initialize dQ = (0)ğ‘ Ã—ğ‘‘","","of size ğµğ‘Ÿ Ã— ğ‘‘ each. Divide",""
"3:
in HBM and divide it into ğ‘‡ğ‘Ÿ blocks dQ1",", . . . , dQğ‘‡ğ‘Ÿ","",""
"","dK, dV âˆˆ Rğ‘ Ã—ğ‘‘ in to ğ‘‡ğ‘ blocks dK1, . . . , dKğ‘‡ğ‘ and dV1, . . . , dVğ‘‡ğ‘ , of size ğµğ‘ Ã— ğ‘‘ each.","",""
"","4: Compute ğ· = rowsum(dO â—¦ O) âˆˆ Rğ‘‘ (pointwise multiply), write ğ· to HBM and divide it into ğ‘‡ğ‘Ÿ blocks","",""
"","","",""
"ğ·1, . . . , ğ·ğ‘‡ğ‘Ÿ of size ğµğ‘Ÿ","","",""
"5:
for 1 â‰¤ ğ‘— â‰¤ ğ‘‡ğ‘ do","","",""
"from HBM to on-chip SRAM.
6:
Load K ğ‘— , V ğ‘—","","",""
"7:
Initialize dK ğ‘— = (0)ğµğ‘ Ã—ğ‘‘, dV ğ‘— = (0)ğµğ‘ Ã—ğ‘‘ on SRAM.","","",""
"8:
for 1 â‰¤ ğ‘– â‰¤ ğ‘‡ğ‘Ÿ do","","",""
"from HBM to on-chip SRAM.","","",""
"9:
Load Qğ‘–, Oğ‘–, dOğ‘–, dQğ‘–, ğ¿ğ‘–, ğ·ğ‘–","","",""
"10:
On chip, compute S( ğ‘— )
= Qğ‘–Kğ‘‡
ğ‘— âˆˆ Rğµğ‘Ÿ Ã—ğµğ‘ .
ğ‘–","","",""
"11:
On chip, compute P( ğ‘— )
= exp(Sğ‘– ğ‘— âˆ’ ğ¿ğ‘–) âˆˆ Rğµğ‘Ÿ Ã—ğµğ‘ .
ğ‘–","","",""
"12:
On chip, compute dV ğ‘— â† dV ğ‘— + (P( ğ‘— )
)âŠ¤dOğ‘– âˆˆ Rğµğ‘ Ã—ğ‘‘.
ğ‘–","","",""
"âˆˆ Rğµğ‘Ÿ Ã—ğµğ‘ .
13:
On chip, compute dP( ğ‘— )
= dOğ‘–VâŠ¤
ğ‘–","","",""
"14:
âˆ’ ğ·ğ‘–) âˆˆ Rğµğ‘Ÿ Ã—ğµğ‘ .
On chip, compute dS( ğ‘— )
= P( ğ‘— )
â—¦ (dP( ğ‘— )
ğ‘–
ğ‘–
ğ‘–","","",""
"15:
Load dQğ‘–
from HBM to SRAM, then on chip, update dQğ‘– â† dQğ‘– + dS( ğ‘— )","","K ğ‘— âˆˆ Rğµğ‘Ÿ Ã—ğ‘‘, and write back",""
"to HBM.","","",""
"âŠ¤","","",""
"16:
On chip, compute dK ğ‘— â† dK ğ‘— + dS( ğ‘— )
Qğ‘– âˆˆ Rğµğ‘ Ã—ğ‘‘.
ğ‘–","","",""
"17:
end for","","",""
"to HBM.
18:
Write dK ğ‘— , dV ğ‘—","","",""
"19: end for","","",""
"20: Return dQ, dK, dV.","","",""
