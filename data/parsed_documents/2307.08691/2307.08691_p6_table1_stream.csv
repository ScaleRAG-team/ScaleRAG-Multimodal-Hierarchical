"","We describe the full FlashAttention-2 forward pass in Algorithm 1.","","","","","","","","","",""
"Algorithm 1 FlashAttention-2 forward pass","","","","","","","","","","",""
"","Require: Matrices Q, K, V âˆˆ Rğ‘ Ã—ğ‘‘ in HBM, block sizes ğµğ‘, ğµğ‘Ÿ .","","","","","","","","","",""
"(cid:108) ğ‘","","","","","","","","","","(cid:108) ğ‘",""
"","","","","","","","","","","","(cid:109) blocks"
"1: Divide Q into ğ‘‡ğ‘Ÿ =
ğµğ‘Ÿ","(cid:109) blocks Q1, . . . , Qğ‘‡ğ‘Ÿ of size ğµğ‘Ÿ Ã— ğ‘‘ each, and divide K, V in to ğ‘‡ğ‘ =","","","","","","","","","ğµğ‘",""
"","K1, . . . , Kğ‘‡ğ‘ and V1, . . . , Vğ‘‡ğ‘ , of size ğµğ‘ Ã— ğ‘‘ each.","","","","","","","","","",""
"","2: Divide the output O âˆˆ Rğ‘ Ã—ğ‘‘ into ğ‘‡ğ‘Ÿ blocks Oğ‘–, . . . , Oğ‘‡ğ‘Ÿ of size ğµğ‘Ÿ Ã— ğ‘‘ each, and divide the logsumexp ğ¿","","","","","","","","","",""
"","","","","","","","","","","",""
"","into ğ‘‡ğ‘Ÿ blocks ğ¿ğ‘–, . . . , ğ¿ğ‘‡ğ‘Ÿ of size ğµğ‘Ÿ","","each.","","","","","","","",""
"3:
for 1 â‰¤ ğ‘– â‰¤ ğ‘‡ğ‘Ÿ do","","","","","","","","","","",""
"4:
Load Qğ‘–","from HBM to on-chip SRAM.","","","","","","","","","",""
"On chip,","","","","","","","","","","",""
"5:
ğ‘–","","= (0)ğµğ‘Ÿ Ã—ğ‘‘ âˆˆ Rğµğ‘Ÿ Ã—ğ‘‘, â„“ (0)","","","= (0)ğµğ‘Ÿ âˆˆ Rğµğ‘Ÿ , ğ‘š (0)","","","= (âˆ’âˆ)ğµğ‘Ÿ âˆˆ Rğµğ‘Ÿ .","","",""
"6:
for 1 â‰¤ ğ‘— â‰¤ ğ‘‡ğ‘ do","","","","","","","","","","",""
"7:
Load K ğ‘— , V ğ‘—","from HBM to on-chip SRAM.","","","","","","","","","",""
"8:","On chip, compute S( ğ‘— )
ğ‘–","= Qğ‘–Kğ‘‡","ğ‘— âˆˆ Rğµğ‘Ÿ Ã—ğµğ‘ .","","","","","","","",""
"On chip,
9:","compute ğ‘š ( ğ‘— )","","= max(ğ‘š ( ğ‘— âˆ’1)",", rowmax(S( ğ‘— )","))","âˆˆ Rğµğ‘Ÿ ,","P( ğ‘— )","= exp(S( ğ‘— )","âˆ’ ğ‘š ( ğ‘— )",")","âˆˆ Rğµğ‘Ÿ Ã—ğµğ‘"
"","ğ‘–","","ğ‘–","ğ‘–","","","ğ‘–","ğ‘–","ğ‘–","",""
"","","âˆ’ğ‘š( ğ‘—)","","","","","","","","",""
"(pointwise), â„“ ( ğ‘— )","= ğ‘’ğ‘š ğ‘— âˆ’1","ğ‘–
â„“ ( ğ‘— âˆ’1)","","+ rowsum( ËœP( ğ‘— )",") âˆˆ Rğµğ‘Ÿ .","","","","","",""
