"","We describe the full FlashAttention-2 forward pass in Algorithm 1.","","","","","","","","","",""
"Algorithm 1 FlashAttention-2 forward pass","","","","","","","","","","",""
"","Require: Matrices Q, K, V ∈ R𝑁 ×𝑑 in HBM, block sizes 𝐵𝑐, 𝐵𝑟 .","","","","","","","","","",""
"(cid:108) 𝑁","","","","","","","","","","(cid:108) 𝑁",""
"","","","","","","","","","","","(cid:109) blocks"
"1: Divide Q into 𝑇𝑟 =
𝐵𝑟","(cid:109) blocks Q1, . . . , Q𝑇𝑟 of size 𝐵𝑟 × 𝑑 each, and divide K, V in to 𝑇𝑐 =","","","","","","","","","𝐵𝑐",""
"","K1, . . . , K𝑇𝑐 and V1, . . . , V𝑇𝑐 , of size 𝐵𝑐 × 𝑑 each.","","","","","","","","","",""
"","2: Divide the output O ∈ R𝑁 ×𝑑 into 𝑇𝑟 blocks O𝑖, . . . , O𝑇𝑟 of size 𝐵𝑟 × 𝑑 each, and divide the logsumexp 𝐿","","","","","","","","","",""
"","","","","","","","","","","",""
"","into 𝑇𝑟 blocks 𝐿𝑖, . . . , 𝐿𝑇𝑟 of size 𝐵𝑟","","each.","","","","","","","",""
"3:
for 1 ≤ 𝑖 ≤ 𝑇𝑟 do","","","","","","","","","","",""
"4:
Load Q𝑖","from HBM to on-chip SRAM.","","","","","","","","","",""
"On chip,","","","","","","","","","","",""
"5:
𝑖","","= (0)𝐵𝑟 ×𝑑 ∈ R𝐵𝑟 ×𝑑, ℓ (0)","","","= (0)𝐵𝑟 ∈ R𝐵𝑟 , 𝑚 (0)","","","= (−∞)𝐵𝑟 ∈ R𝐵𝑟 .","","",""
"6:
for 1 ≤ 𝑗 ≤ 𝑇𝑐 do","","","","","","","","","","",""
"7:
Load K 𝑗 , V 𝑗","from HBM to on-chip SRAM.","","","","","","","","","",""
"8:","On chip, compute S( 𝑗 )
𝑖","= Q𝑖K𝑇","𝑗 ∈ R𝐵𝑟 ×𝐵𝑐 .","","","","","","","",""
"On chip,
9:","compute 𝑚 ( 𝑗 )","","= max(𝑚 ( 𝑗 −1)",", rowmax(S( 𝑗 )","))","∈ R𝐵𝑟 ,","P( 𝑗 )","= exp(S( 𝑗 )","− 𝑚 ( 𝑗 )",")","∈ R𝐵𝑟 ×𝐵𝑐"
"","𝑖","","𝑖","𝑖","","","𝑖","𝑖","𝑖","",""
"","","−𝑚( 𝑗)","","","","","","","","",""
"(pointwise), ℓ ( 𝑗 )","= 𝑒𝑚 𝑗 −1","𝑖
ℓ ( 𝑗 −1)","","+ rowsum( ˜P( 𝑗 )",") ∈ R𝐵𝑟 .","","","","","",""
