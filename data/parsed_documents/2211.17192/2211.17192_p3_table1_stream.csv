"Fast Inference from Transformers via Speculative Decoding",""
"probability distribution, and cast all of the other types of","ber of tokens produced by a single run of Algorithm 1."
"sampling into that framework. Going forward we’ll assume",""
"","Deﬁnition 3.1. The acceptance rate βx<t , given a preﬁx"
"that p(x) and q(x) are the distributions from Mp and Mq",""
"","x<t,
is the probability of accepting xt ∼ q(xt|x<t) by"
"respectively, adjusted for the sampling method.",""
"","speculative sampling, as per Section 2.32."
"2.3. Speculative Sampling",""
"","E(β) is then a natural measure of how well Mq approxi-"
"","mates Mp. If we make the simplifying assumption that the"
"To sample x ∼ p(x), we instead sample x ∼ q(x), keeping",""
"","βs are i.i.d., and denote α = E(β),
then the number of"
"it
if q(x) ≤ p(x), and in case q(x) > p(x) we reject
the",""
"","tokens produced by a single run of Algorithm 1 is a capped"
"sample with probability 1− p(x)",""
"q(x) and sample x again from an",""
"","geometric variable, with success probability 1 − α and cap"
"adjusted distribution p(cid:48)(x) = norm(max(0, p(x) − q(x)))",""
"","γ + 1, and the expected number of
tokens generated by"
"instead. It’s easy to show (see Appendix A.1) that for any",""
"","Algorithm 1 satisﬁes Equation (1). See Figure 2."
"distributions p(x) and q(x), and x sampled in this way,",""
"indeed x ∼ p(x).",""
"","1 − αγ+1"
"Given the distribution q(x) obtained from running Mq on","E(# generated tokens) =
(1)"
"","1 − α"
"a conditioning pref ix, we can sample a token x1 ∼ q(x).",""
"We then calculate the distribution p(x) by running Mp on",""
"pref ix while in parallel speculatively calculating the distri-",""
"bution of the next token x2 by running Mp on pref ix+[x1].",""
"","10
10"
"Once both computations complete, we proceed as per above:","Baseline"
"","= 1"
"If x1
is rejected, we discard the computation of x2 and",""
"","= 3"
"",""
"re-sample x1 from an adjusted distribution, and if x1 is ac-","8
8
= 5"
"","= 7"
"cepted, we keep both tokens. Algorithm 1 generalizes this",""
"","="
"idea to sample between 1 and γ + 1 tokens at once.","6
6"
"Algorithm 1 SpeculativeDecodingStep","E(tokens per iteration)
4
4"
"Inputs: Mp, Mq, pref ix.",""
