"","","= 7","",""
"","cepted, we keep both tokens. Algorithm 1 generalizes this","","",""
"","","=","",""
"idea to sample between 1 and γ + 1 tokens at once.","","6","6",""
"Algorithm 1 SpeculativeDecodingStep","","E(tokens per iteration)
4","4",""
"Inputs: Mp, Mq, pref ix.","","","",""
"","(cid:46) Sample γ guesses x1,...,γ from Mq autoregressively.","","",""
"","","2","2",""
"for i = 1 to γ do","","","",""
"","","1","1",""
"qi(x) ← Mq(pref ix + [x1, . . . , xi−1])","","","",""
"","","0","0",""
"xi ∼ qi(x)","","0.50
0.55
0.60
0.65
0.70
0.75
0.80
0.85
0.90","",""
"end for","","","",""
"(cid:46) Run Mp in parallel.","","","",""
"","","","Figure 2. The expected number of tokens generated by Algorithm 1",""
"p1(x), . . . , pγ+1(x) ←","","","",""
"","","as a function of α for various values of γ.","",""
"","Mp(pref ix), . . . , Mp(pref ix + [x1, . . . , xγ])","","",""
"(cid:46) Determine the number of accepted guesses n.","","","",""
"r1 ∼ U (0, 1), . . . , rγ ∼ U (0, 1)","","","",""
"","","3.2. Calculating α","",""
"n ← min({i − 1 | 1 ≤ i ≤ γ, ri > pi(x)","","","",""
"","qi(x) } ∪ {γ})","","",""
"","","","We’ll now derive a simple formula for calculating α given a",""
"(cid:46) Adjust the distribution from Mp if needed.","","","",""
"","","","preﬁx and the two models Mp and Mq. We start by deﬁning",""
"p(cid:48)(x) ← pn+1(x)","","","",""
"","","a natural divergence DLK:","",""
"if n < γ then","","","",""
"","p(cid:48)(x) ← norm(max(0, pn+1(x) − qn+1(x)))","= (cid:80)
Deﬁnition 3.2. DLK(p, q)","","="
"","","","x |p(x) − M (x)|",""
"end if","","(cid:80)","",""
"","","","",""
"","",".
x |q(x) − M (x)| where M (x) = p(x)+q(x)","",""
"","(cid:46) Return one token from Mp, and n tokens from Mq.","","",""
"","","Lemma 3.3. DLK(p, q) = 1 − (cid:80)
x min(p(x), q(x))","",""
"t ∼ p(cid:48)(x)","","","",""
"return pref ix + [x1, . . . , xn, t]","","","",""
"","","","",""
"","","","|p−q|",""
"","","x |p(x) − M (x)| = (cid:80)","","="
